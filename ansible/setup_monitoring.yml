---
- name: Setup Monitoring on Slurm Cluster
  hosts: slurm_cluster
  become: yes
  tasks:
    - name: Ensure monitoring directory exists
      file:
        path: /usr/local/bin/monitoring
        state: directory
        mode: '0755'

    - name: Copy hardware monitoring script
      copy:
        src: ../monitoring/check_hardware.sh
        dest: /usr/local/bin/monitoring/check_hardware.sh
        mode: '0755'

    - name: Copy Slurm node monitoring script
      copy:
        src: ../monitoring/check_slurm_nodes.sh
        dest: /usr/local/bin/monitoring/check_slurm_nodes.sh
        mode: '0755'

    - name: Ensure cron is installed
      package:
        name: cron
        state: present

    - name: Create cron job for hardware monitoring (every 15 mins)
      cron:
        name: "check hardware health"
        minute: "*/15"
        job: "/usr/local/bin/monitoring/check_hardware.sh >> /var/log/hardware_health.log 2>&1"

    - name: Create cron job for Slurm node monitoring (every 5 mins)
      cron:
        name: "check slurm nodes"
        minute: "*/5"
        job: "/usr/local/bin/monitoring/check_slurm_nodes.sh >> /var/log/slurm_health.log 2>&1"
