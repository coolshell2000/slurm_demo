services:
  mysql:
    image: mariadb:12
    hostname: mysql
    container_name: mysql
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "yes"
      MYSQL_DATABASE: ${MYSQL_DATABASE:-slurm_acct_db}
      MYSQL_USER: ${MYSQL_USER:-slurm}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
    volumes:
      - var_lib_mysql:/var/lib/mysql
    networks:
      - slurm-network
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--connect", "--innodb_initialized" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  slurmdbd:
    image: slurm-docker-cluster:${SLURM_VERSION:-25.05.3}
    build:
      context: .
      args:
        SLURM_VERSION: ${SLURM_VERSION:-25.05.3}
        TARGETARCH: amd64
      cache_from:
        - slurm-docker-cluster:${SLURM_VERSION:-25.05.3}
    command: [ "slurmdbd" ]
    container_name: slurmdbd
    hostname: slurmdbd
    environment:
      MYSQL_USER: ${MYSQL_USER:-slurm}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
    volumes:
      - etc_munge:/etc/munge
      - etc_slurm:/etc/slurm
      - var_log_slurm:/var/log/slurm
    expose:
      - "6819"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - slurm-network
    healthcheck:
      test: [ "CMD-SHELL", "pidof slurmdbd" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  slurmctld:
    image: slurm-docker-cluster:${SLURM_VERSION:-25.05.3}
    command: [ "slurmctld" ]
    container_name: slurmctld
    hostname: slurmctld
    working_dir: /data
    volumes:
      - etc_munge:/etc/munge:z
      - etc_slurm:/etc/slurm:z
      - slurm_jobdir:/data:z
      - var_log_slurm:/var/log/slurm:z
      - slurm_home:/home:z
    expose:
      - "6817"
    depends_on:
      slurmdbd:
        condition: service_healthy
    networks:
      - slurm-network
    healthcheck:
      test: [ "CMD-SHELL", "scontrol ping" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  slurmrestd:
    image: slurm-docker-cluster:${SLURM_VERSION:-25.05.3}
    command: [ "slurmrestd" ]
    container_name: slurmrestd
    hostname: slurmrestd
    privileged: true
    volumes:
      - etc_munge:/etc/munge
      - etc_slurm:/etc/slurm
      - var_log_slurm:/var/log/slurm
    ports:
      - "6820:6820"
    expose:
      - "6820"
    depends_on:
      slurmctld:
        condition: service_healthy
    networks:
      - slurm-network
    healthcheck:
      test: [ "CMD-SHELL", "test -S /var/run/slurmrestd/slurmrestd.socket" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  c1:
    image: slurm-docker-cluster:${SLURM_VERSION:-25.05.3}
    command: [ "slurmd" ]
    container_name: c1
    hostname: c1
    working_dir: /data
    privileged: true
    volumes:
      - etc_munge:/etc/munge
      - etc_slurm:/etc/slurm
      - slurm_jobdir:/data
      - var_log_slurm:/var/log/slurm
      - slurm_home:/home
    expose:
      - "6818"
    depends_on:
      slurmctld:
        condition: service_healthy
    networks:
      - slurm-network
    healthcheck:
      test: [ "CMD-SHELL", "pidof slurmd" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  c2:
    image: slurm-docker-cluster:${SLURM_VERSION:-25.05.3}
    command: [ "slurmd" ]
    container_name: c2
    hostname: c2
    working_dir: /data
    privileged: true
    volumes:
      - etc_munge:/etc/munge
      - etc_slurm:/etc/slurm
      - slurm_jobdir:/data
      - var_log_slurm:/var/log/slurm
      - slurm_home:/home
    expose:
      - "6818"
    depends_on:
      slurmctld:
        condition: service_healthy
    networks:
      - slurm-network
    healthcheck:
      test: [ "CMD-SHELL", "pidof slurmd" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  c3:
    image: slurm-docker-cluster:${SLURM_VERSION:-25.05.3}
    command: [ "slurmd" ]
    container_name: c3
    hostname: c3
    working_dir: /data
    privileged: true
    volumes:
      - etc_munge:/etc/munge
      - etc_slurm:/etc/slurm
      - slurm_jobdir:/data
      - var_log_slurm:/var/log/slurm
      - slurm_home:/home
    expose:
      - "6818"
    depends_on:
      slurmctld:
        condition: service_healthy
    networks:
      - slurm-network
    healthcheck:
      test: [ "CMD-SHELL", "pidof slurmd" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  c4:
    image: slurm-docker-cluster:${SLURM_VERSION:-25.05.3}
    command: [ "slurmd" ]
    container_name: c4
    hostname: c4
    working_dir: /data
    privileged: true
    volumes:
      - etc_munge:/etc/munge
      - etc_slurm:/etc/slurm
      - slurm_jobdir:/data
      - var_log_slurm:/var/log/slurm
      - slurm_home:/home
    expose:
      - "6818"
    depends_on:
      slurmctld:
        condition: service_healthy
    networks:
      - slurm-network
    healthcheck:
      test: [ "CMD-SHELL", "pidof slurmd" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  c5:
    image: slurm-docker-cluster:${SLURM_VERSION:-25.05.3}
    command: [ "slurmd" ]
    container_name: c5
    hostname: c5
    working_dir: /data
    privileged: true
    volumes:
      - etc_munge:/etc/munge
      - etc_slurm:/etc/slurm
      - slurm_jobdir:/data
      - var_log_slurm:/var/log/slurm
      - slurm_home:/home
    expose:
      - "6818"
    depends_on:
      slurmctld:
        condition: service_healthy
    networks:
      - slurm-network
    healthcheck:
      test: [ "CMD-SHELL", "pidof slurmd" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - slurm-network

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/etc/grafana/dashboards_json/slurm_dashboard.json
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/etc/grafana/dashboards_json
    networks:
      - slurm-network

  slurm-exporter:
    build:
      context: .
      dockerfile: Dockerfile.exporter
    image: slurm-exporter:latest
    container_name: slurm-exporter
    environment:
      - SLURM_CONF=/etc/slurm/slurm.conf
    volumes:
      - etc_slurm:/etc/slurm:ro
      - var_run_slurm:/var/run/slurm:ro
      - etc_munge:/etc/munge:ro
    networks:
      - slurm-network
    depends_on:
      - slurmctld

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    volumes:
      - /:/host:ro,rslave
    command:
      - '--path.rootfs=/host'
    ports:
      - "9100:9100"
    networks:
      - slurm-network

volumes:
  etc_munge:
  etc_slurm:
  slurm_jobdir:
  var_lib_mysql:
  var_log_slurm:
  var_run_slurm:
  slurm_home:


networks:
  slurm-network:
    driver: bridge
